name: Auto Deploy on Release
run-name: ğŸš€ Auto deploying release

on:
  release:
    types: [created] # runs when a release is first created

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.env-check.outputs.env }}
      app: ${{ steps.env-check.outputs.app }}
      should-deploy: ${{ steps.env-check.outputs.should-deploy }}
    steps:
      - name: Determine environment and app from release title
        id: env-check
        run: |
          RELEASE_TITLE="${{ github.event.release.name }}"
          echo "ğŸ“ Release title: $RELEASE_TITLE"

          ENV=""
          APP=""
          SHOULD_DEPLOY="false"

          # Determine environment from title prefix
          if [[ "$RELEASE_TITLE" =~ ^uat-.* ]]; then
            ENV="uat"
            SHOULD_DEPLOY="true"
            echo "âœ… UAT deployment detected from release title"
          elif [[ "$RELEASE_TITLE" =~ ^prod-.* ]]; then
            ENV="prod"
            SHOULD_DEPLOY="true"
            echo "âœ… PROD deployment detected from release title"
          else
            echo "âŒ Cannot determine environment from release title"
            echo "   Expected formats:"
            echo "   - uat-v1.0.0"
            echo "   - prod-v1.0.0"
          fi

          # Determine app type from title (default all)
          if [[ "$RELEASE_TITLE" =~ ssr ]]; then
            APP="ssr"
            echo "ğŸ“¦ SSR app detected from title"
          elif [[ "$RELEASE_TITLE" =~ web ]]; then
            APP="web"
            echo "ğŸ“¦ Web app selected (default)"
          else
            APP="all"
            echo "ğŸ“¦All apps selected (default)"
          fi

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "app=$APP" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ¯ Deployment Summary:"
          echo "   Environment: $ENV"
          echo "   App: $APP"
          echo "   Should Deploy: $SHOULD_DEPLOY"

  deploy:
    needs: determine-environment
    runs-on: self-hosted
    timeout-minutes: 60
    if: needs.determine-environment.outputs.should-deploy == 'true'
    environment: ${{ needs.determine-environment.outputs.env }}
    steps:
      - name: Show deployment context
        run: |
          echo "ğŸ‰ Auto deployment triggered by release"
          echo "ğŸ“ Release title: ${{ github.event.release.name }}"
          echo "ğŸŒ Environment: ${{ needs.determine-environment.outputs.env }}"
          echo "ğŸ“¦ App: ${{ needs.determine-environment.outputs.app }}"
          echo "ğŸ‘¤ Released by: ${{ github.event.release.author.login }}"
          echo "ğŸ”— Release URL: ${{ github.event.release.html_url }}"

      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Deploy specific
        if: needs.determine-environment.outputs.app != 'all'
        run: |
          ssh frontend "deploy Unirefund  ${{ github.event.release.name }} ${{ needs.determine-environment.outputs.app }}"

      - name: Deploy all apps
        if: needs.determine-environment.outputs.app == 'all'
        run: |
          ssh frontend "deploy Unirefund ${{ github.event.release.name }}"

  notify-skipped:
    needs: determine-environment
    runs-on: ubuntu-latest
    if: needs.determine-environment.outputs.should-deploy == 'false'
    steps:
      - run: |
          echo "â­ï¸  Deployment skipped for release: ${{ github.event.release.name }}"
          echo "ğŸ’¡ To enable auto-deployment, name the release like:"
          echo "   uat-v1.0.0"
          echo "   prod-v1.0.0"
          echo "::error::Deployment was skipped due to invalid release name format"
          exit 1
